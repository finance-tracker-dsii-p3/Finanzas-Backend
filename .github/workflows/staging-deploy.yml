name: Staging Deploy

on:
  push:
    branches: [ develop, staging ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run quick tests
        run: |
          python manage.py check
          python manage.py test --verbosity 2 --parallel --keepdb || true

      - name: Set service info
        id: service
        run: |
          # Para develop/staging, usamos los secretos principales
          echo "service_id=${{ secrets.RENDER_SERVICE_ID }}" >> $GITHUB_OUTPUT
          echo "service_url=${{ secrets.RENDER_SERVICE_URL }}" >> $GITHUB_OUTPUT
          echo "âœ… Using service ID: ${{ secrets.RENDER_SERVICE_ID }}"
          echo "âœ… Using service URL: ${{ secrets.RENDER_SERVICE_URL }}"

      - name: Deploy to Staging
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ steps.service.outputs.service_id }}
          api-key: ${{ secrets.RENDER_API_KEY }}

      - name: Staging Health Check
        run: |
          echo "ğŸ­ Testing staging deployment..."
          sleep 45
          
          # Test basic connectivity with retries
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            if curl -f -s "${{ steps.service.outputs.service_url }}/health/" > /dev/null; then
              echo "âœ… Staging health check passed!"
              break
            elif [ $attempt -eq $max_attempts ]; then
              echo "âŒ Staging health check failed after $max_attempts attempts"
              exit 1
            else
              echo "â³ Attempt $attempt failed, retrying..."
              sleep 30
            fi
            attempt=$((attempt + 1))
          done

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ­ **Staging deployed successfully!**\n\nğŸ“ URL: ${{ steps.service.outputs.service_url }}\n\nâœ… Ready for testing'
            })