name: Deploy

on:
  push:
    branches: [develop ]
  workflow_run:
    workflows: ["CI (Tests Only)"]
    types: [completed]
    branches: [develop ]

jobs:
  # Job condicional: solo ejecutar si los tests pasaron
  check-tests:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    outputs:
      deploy-needed: ${{ steps.check.outputs.result }}
      branch: ${{ steps.branch.outputs.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get branch name
        id: branch
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "name=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          else
            echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Check if deployment needed
        id: check
        run: |
          echo "Tests passed, proceeding with deployment to ${{ steps.branch.outputs.name }}"
          echo "result=true" >> $GITHUB_OUTPUT

  # Job principal de despliegue
  deploy:
    needs: check-tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ needs.check-tests.outputs.deploy-needed == 'true' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Render
        id: deploy
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}

      - name: Wait for deployment
        run: |
          echo "‚úÖ Deployment triggered successfully"
          echo "‚è≥ Waiting for Render deployment to complete..."
          sleep 90

      - name: Health Check
        continue-on-error: true
        run: |
          echo "ÔøΩ Testing service connectivity..."
          
          SERVICE_URL="${{ secrets.RENDER_SERVICE_URL }}"
          
          if [[ -n "$SERVICE_URL" && "$SERVICE_URL" != "null" ]]; then
            echo "üåê Testing: $SERVICE_URL"
            
            # Test basic connectivity
            if curl -f -s "$SERVICE_URL/" > /dev/null 2>&1; then
              echo "‚úÖ Basic connectivity: OK"
            else
              echo "‚ö†Ô∏è Basic connectivity failed, service may still be starting"
            fi
            
            # Test health endpoint
            if curl -f -s "$SERVICE_URL/health/" > /dev/null 2>&1; then
              echo "‚úÖ Health endpoint: OK"
            else
              echo "‚ÑπÔ∏è Health endpoint not available yet"
            fi
          else
            echo "‚ö†Ô∏è RENDER_SERVICE_URL not configured, skipping health check"
          fi
          
          echo "üéâ Deployment process completed!"

  # Job de notificaci√≥n (opcional)
  notify:
    needs: [check-tests, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify deployment status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ Deployment successful to ${{ needs.check-tests.outputs.branch }}"
          else
            echo "‚ùå Deployment failed to ${{ needs.check-tests.outputs.branch }}"
            exit 1
          fi
